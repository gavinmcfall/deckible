name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  ansible-lint:
    name: Ansible Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install ansible-lint and dependencies
        run: |
          pip install ansible-lint==25.1.0 ansible==10.7.0
          ansible-galaxy collection install community.general

      - name: Run ansible-lint
        run: ansible-lint config/steamdeck/

  shellcheck:
    name: ShellCheck
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Run ShellCheck
        uses: ludeeus/action-shellcheck@master
        with:
          scandir: './targets'
          additional_files: 'init-private-repo.sh scripts/update-checksums.sh'

  powershell-lint:
    name: PowerShell Lint
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Run PSScriptAnalyzer
        shell: pwsh
        run: |
          Install-Module -Name PSScriptAnalyzer -Force -Scope CurrentUser -RequiredVersion 1.23.0
          $results = @()

          # Analyze all PowerShell files
          $files = Get-ChildItem -Path . -Include *.ps1 -Recurse -Exclude *.Tests.ps1
          foreach ($file in $files) {
            $analysis = Invoke-ScriptAnalyzer -Path $file.FullName -Severity Warning,Error
            if ($analysis) {
              $results += $analysis
              foreach ($issue in $analysis) {
                $level = if ($issue.Severity -eq 'Error') { 'error' } else { 'warning' }
                Write-Host "::${level} file=$($file.FullName),line=$($issue.Line),col=$($issue.Column)::$($issue.RuleName): $($issue.Message)"
              }
            }
          }

          # Fail if there are errors (not just warnings)
          $errors = $results | Where-Object { $_.Severity -eq 'Error' }
          if ($errors) {
            foreach ($err in $errors) {
              Write-Host "ERROR: $($err.ScriptPath):$($err.Line) - $($err.RuleName): $($err.Message)"
            }
            Write-Host "::error::Found $($errors.Count) error(s)"
            exit 1
          }

          Write-Host "PSScriptAnalyzer passed with $($results.Count) warning(s)"

  powershell-tests:
    name: PowerShell Tests
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Run Pester Tests
        shell: pwsh
        run: |
          Install-Module -Name Pester -Force -Scope CurrentUser -RequiredVersion 5.6.1
          $config = New-PesterConfiguration
          $config.Run.Path = "./tests"
          $config.Output.Verbosity = "Detailed"
          $config.TestResult.Enabled = $true
          $config.TestResult.OutputPath = "test-results.xml"
          Invoke-Pester -Configuration $config

  yaml-lint:
    name: YAML Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install yamllint
        run: pip install yamllint==1.35.1

      - name: Run yamllint
        run: yamllint -c .yamllint.yml . || true  # Don't fail on warnings initially

  validate-checksums:
    name: Validate Checksums
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Check script checksums match worker
        run: |
          ALLY_HASH=$(sha256sum targets/ally.ps1 | cut -d' ' -f1)
          DECK_HASH=$(sha256sum targets/deck.sh | cut -d' ' -f1)
          ANDROID_HASH=$(sha256sum targets/android.sh | cut -d' ' -f1)

          # Extract checksums by looking for path context (more reliable than position)
          ALLY_EXPECTED=$(grep -A3 "'/rog':" cloudflare/_worker.js | grep sha256 | sed "s/.*sha256: '\\([a-f0-9]*\\)'.*/\\1/")
          DECK_EXPECTED=$(grep -A3 "'/deck':" cloudflare/_worker.js | grep sha256 | sed "s/.*sha256: '\\([a-f0-9]*\\)'.*/\\1/")
          ANDROID_EXPECTED=$(grep -A3 "'/android':" cloudflare/_worker.js | grep sha256 | sed "s/.*sha256: '\\([a-f0-9]*\\)'.*/\\1/")

          FAILED=0

          if [ "$ALLY_HASH" != "$ALLY_EXPECTED" ]; then
            echo "::error::ally.ps1 checksum mismatch!"
            echo "  Expected: $ALLY_EXPECTED"
            echo "  Got:      $ALLY_HASH"
            echo "  Run: ./scripts/update-checksums.sh"
            FAILED=1
          fi

          if [ "$DECK_HASH" != "$DECK_EXPECTED" ]; then
            echo "::error::deck.sh checksum mismatch!"
            echo "  Expected: $DECK_EXPECTED"
            echo "  Got:      $DECK_HASH"
            echo "  Run: ./scripts/update-checksums.sh"
            FAILED=1
          fi

          if [ "$ANDROID_HASH" != "$ANDROID_EXPECTED" ]; then
            echo "::error::android.sh checksum mismatch!"
            echo "  Expected: $ANDROID_EXPECTED"
            echo "  Got:      $ANDROID_HASH"
            echo "  Run: ./scripts/update-checksums.sh"
            FAILED=1
          fi

          if [ $FAILED -eq 1 ]; then
            exit 1
          fi

          echo "All checksums valid"
