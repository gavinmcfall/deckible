# Bootible - Steam Deck Playbook
# ===============================
# Automates the setup and configuration of a Steam Deck.
#
# Usage:
#   cd steamdeck
#   ansible-playbook playbook.yml --ask-become-pass
#
# Configuration:
#   - Defaults: config.yml
#   - Your settings: ../private/steamdeck/config.yml (overrides defaults)
#   - Private files: ../private/steamdeck/files/ (Patreon downloads, etc.)
#
# See README.md for full documentation.

---
- name: Configure Steam Deck
  hosts: localhost
  gather_facts: true

  vars_files:
    - config.yml

  pre_tasks:
    - name: Verify running on Steam Deck or compatible system
      ansible.builtin.assert:
        that:
          - ansible_facts['distribution'] == "Arch" or ansible_facts['os_family'] == "Archlinux"
        fail_msg: "This playbook is designed for SteamOS/Arch Linux"
        success_msg: "Running on compatible system: {{ ansible_facts['distribution'] }}"
      tags: always

    # Load configuration overrides
    # Priority: private repo > local ~/.config > defaults

    - name: Check for local configuration
      ansible.builtin.stat:
        path: "{{ ansible_facts['env']['HOME'] }}/.config/bootible/steamdeck/config.yml"
      register: local_config
      tags: always

    - name: Load local configuration
      ansible.builtin.include_vars:
        file: "{{ ansible_facts['env']['HOME'] }}/.config/bootible/steamdeck/config.yml"
      when: local_config.stat.exists
      tags: always

    - name: Check for private configuration
      ansible.builtin.stat:
        path: "{{ playbook_dir }}/../private/steamdeck/config.yml"
      register: private_config
      tags: always

    - name: Load private configuration
      ansible.builtin.include_vars:
        file: "{{ playbook_dir }}/../private/steamdeck/config.yml"
      when: private_config.stat.exists
      tags: always

    - name: Note configuration source
      ansible.builtin.debug:
        msg: >-
          {% if private_config.stat.exists %}Using private config (private/steamdeck/config.yml)
          {% elif local_config.stat.exists %}Using local config (~/.config/bootible/steamdeck/config.yml)
          {% else %}Using default config.yml{% endif %}
      tags: always

    # Validate configuration schema
    # Reports ALL errors before failing. Catches misconfigurations early.
    - name: Validate configuration schema
      vars:
        # Schema definition: variable => expected type
        # Types: 'string', 'int', 'bool', 'list', 'dict'
        schema:
          # System
          hostname: 'string'
          create_snapshot: 'bool'
          github_token: 'string'

          # SSH
          install_ssh: 'bool'
          ssh_port: 'int'
          ssh_import_authorized_keys: 'bool'
          ssh_authorized_keys: 'list'
          ssh_key_name: 'string'
          ssh_generate_key: 'bool'
          ssh_add_to_github: 'bool'
          ssh_save_to_private: 'bool'
          ssh_configure_git: 'bool'

          # Package managers
          package_managers_flatpak: 'bool'
          package_managers_pacman: 'bool'
          package_managers_nix: 'bool'

          # Remote access
          install_tailscale: 'bool'
          install_remote_desktop: 'bool'
          install_sunshine: 'bool'
          install_vnc: 'bool'

          # Gaming
          install_decky: 'bool'
          install_proton_tools: 'bool'
          install_protonup_qt: 'bool'
          install_proton_ge: 'bool'
          install_protontricks: 'bool'
          install_waydroid: 'bool'
          install_emudeck: 'bool'
          install_stickdeck: 'bool'
          install_cryoutilities: 'bool'

          # Apps
          install_flatpak_apps: 'bool'
          install_discord: 'bool'
          install_signal: 'bool'
          install_spotify: 'bool'
          install_vlc: 'bool'
          install_firefox: 'bool'
          install_chromium: 'bool'
          install_obs: 'bool'
          install_vscode: 'bool'
          install_flatseal: 'bool'
          install_anydesk: 'bool'
          install_chiaki: 'bool'
          install_moonlight: 'bool'
          install_greenlight: 'bool'
          install_plex: 'bool'
          install_jellyfin: 'bool'
          install_telegram: 'bool'
          install_slack: 'bool'
          install_element: 'bool'
          install_zoom: 'bool'
          install_libreoffice: 'bool'
          install_gimp: 'bool'
          install_thunderbird: 'bool'
          install_syncthing: 'bool'
          install_qbittorrent: 'bool'
          install_filezilla: 'bool'
          install_heroic: 'bool'
          install_lutris: 'bool'
          install_bottles: 'bool'
          install_neovim: 'bool'

          # Storage
          move_shader_cache: 'bool'

          # Paths
          deck_home: 'string'

        # Collect all validation errors
        validation_errors: >-
          {%- set errors = [] -%}
          {# Check hostname (string) #}
          {%- if hostname is defined and hostname is not string -%}
            {%- set _ = errors.append('hostname: expected string, got ' ~ hostname | type_debug) -%}
          {%- endif -%}
          {# Check create_snapshot (bool) #}
          {%- if create_snapshot is defined and create_snapshot is not sameas true and create_snapshot is not sameas false -%}
            {%- set _ = errors.append('create_snapshot: expected bool, got ' ~ create_snapshot | type_debug ~ ' (' ~ create_snapshot ~ ')') -%}
          {%- endif -%}
          {# Check ssh_port (int) #}
          {%- if ssh_port is defined and ssh_port is not number -%}
            {%- set _ = errors.append('ssh_port: expected int, got ' ~ ssh_port | type_debug ~ ' (' ~ ssh_port ~ ')') -%}
          {%- endif -%}
          {# Check package_managers (nested bools) #}
          {%- if package_managers is defined -%}
            {%- if package_managers.flatpak is defined and package_managers.flatpak is not sameas true and package_managers.flatpak is not sameas false -%}
              {%- set _ = errors.append('package_managers.flatpak: expected bool, got ' ~ package_managers.flatpak | type_debug) -%}
            {%- endif -%}
            {%- if package_managers.pacman is defined and package_managers.pacman is not sameas true and package_managers.pacman is not sameas false -%}
              {%- set _ = errors.append('package_managers.pacman: expected bool, got ' ~ package_managers.pacman | type_debug) -%}
            {%- endif -%}
            {%- if package_managers.nix is defined and package_managers.nix is not sameas true and package_managers.nix is not sameas false -%}
              {%- set _ = errors.append('package_managers.nix: expected bool, got ' ~ package_managers.nix | type_debug) -%}
            {%- endif -%}
          {%- endif -%}
          {# Check all install_* bools #}
          {%- for var in ['install_ssh', 'install_tailscale', 'install_remote_desktop', 'install_sunshine', 'install_vnc',
                          'install_decky', 'install_proton_tools', 'install_protonup_qt', 'install_proton_ge', 'install_protontricks',
                          'install_waydroid', 'install_emudeck', 'install_stickdeck', 'install_cryoutilities',
                          'install_flatpak_apps', 'install_discord', 'install_signal', 'install_spotify', 'install_vlc',
                          'install_firefox', 'install_chromium', 'install_obs', 'install_vscode', 'install_flatseal',
                          'install_anydesk', 'install_chiaki', 'install_moonlight', 'install_greenlight',
                          'install_plex', 'install_jellyfin', 'install_telegram', 'install_slack', 'install_element',
                          'install_zoom', 'install_libreoffice', 'install_gimp', 'install_thunderbird',
                          'install_syncthing', 'install_qbittorrent', 'install_filezilla', 'install_heroic',
                          'install_lutris', 'install_bottles', 'install_neovim', 'move_shader_cache'] -%}
            {%- set val = lookup('vars', var, default=None) -%}
            {%- if val is not none and val is not sameas true and val is not sameas false -%}
              {%- set _ = errors.append(var ~ ': expected bool, got ' ~ val | type_debug ~ ' (' ~ val ~ ')') -%}
            {%- endif -%}
          {%- endfor -%}
          {# Check string types #}
          {%- for var in ['github_token', 'deck_home'] -%}
            {%- set val = lookup('vars', var, default=None) -%}
            {%- if val is not none and val is not string -%}
              {%- set _ = errors.append(var ~ ': expected string, got ' ~ val | type_debug) -%}
            {%- endif -%}
          {%- endfor -%}
          {# Check password_manager enum #}
          {%- if password_manager is defined -%}
            {%- set allowed_pm = ['1password', 'bitwarden', 'keepassxc', 'protonpass', 'none'] -%}
            {%- if password_manager not in allowed_pm -%}
              {%- set _ = errors.append('password_manager: expected one of [' ~ allowed_pm | join(', ') ~ '], got ' ~ password_manager) -%}
            {%- endif -%}
          {%- endif -%}
          {# Check password_manager_install_method enum #}
          {%- if password_manager_install_method is defined -%}
            {%- set allowed_pmim = ['flatpak', 'distrobox'] -%}
            {%- if password_manager_install_method not in allowed_pmim -%}
              {%- set _ = errors.append('password_manager_install_method: expected one of [' ~ allowed_pmim | join(', ') ~ '], got ' ~ password_manager_install_method) -%}
            {%- endif -%}
          {%- endif -%}
          {# Check emulation_storage enum #}
          {%- if emulation_storage is defined -%}
            {%- set allowed_es = ['auto', 'internal', 'sdcard'] -%}
            {%- if emulation_storage not in allowed_es -%}
              {%- set _ = errors.append('emulation_storage: expected one of [' ~ allowed_es | join(', ') ~ '], got ' ~ emulation_storage) -%}
            {%- endif -%}
          {%- endif -%}
          {{ errors | to_json }}
      ansible.builtin.assert:
        that:
          - (validation_errors | from_json | length) == 0
        fail_msg: |

          ═══════════════════════════════════════════════════════════════
                          CONFIGURATION ERRORS FOUND
          ═══════════════════════════════════════════════════════════════

          The following configuration values have incorrect types:

          {% for err in (validation_errors | from_json) %}
            - {{ err }}
          {% endfor %}

          Fix the above errors in your config.yml before continuing.

        success_msg: "Configuration schema valid"
      tags: always

    # Set private files path for roles to use
    - name: Set private files path
      ansible.builtin.set_fact:
        private_files_path: "{{ playbook_dir }}/../private/steamdeck/files"
        local_files_path: "{{ playbook_dir }}/../files/steamdeck"
        has_private_files: "{{ (playbook_dir + '/../private/steamdeck/files') is directory }}"
      tags: always

    # Create btrfs snapshot before making changes
    - name: Check if home is on btrfs
      ansible.builtin.command: stat -f -c %T /home
      register: home_fs_type
      changed_when: false
      failed_when: false
      when: create_snapshot | default(true)
      tags: always

    - name: Check for recent bootible snapshot
      become: true
      ansible.builtin.shell: |
        set -o pipefail
        SNAPSHOT_DIR="/home/.snapshots"
        # Check if a bootible snapshot was created in the last hour
        if [ -d "$SNAPSHOT_DIR" ]; then
          find "$SNAPSHOT_DIR" -maxdepth 1 -name "bootible-pre-setup-*" -mmin -60 | head -1
        fi
      args:
        executable: /bin/bash
      register: recent_snapshot
      changed_when: false
      failed_when: false
      when:
        - create_snapshot | default(true)
        - home_fs_type.stdout | default('') == 'btrfs'
      tags: always

    - name: Create btrfs snapshot of home directory
      become: true
      ansible.builtin.shell: |
        set -o pipefail
        SNAPSHOT_DIR="/home/.snapshots"
        SNAPSHOT_NAME="bootible-pre-setup-$(date +%Y%m%d-%H%M%S)"
        mkdir -p "$SNAPSHOT_DIR"
        btrfs subvolume snapshot -r /home "$SNAPSHOT_DIR/$SNAPSHOT_NAME"
        echo "Created snapshot: $SNAPSHOT_DIR/$SNAPSHOT_NAME"
      args:
        executable: /bin/bash
      register: snapshot_result
      when:
        - create_snapshot | default(true)
        - home_fs_type.stdout | default('') == 'btrfs'
        - not ansible_check_mode
        - recent_snapshot.stdout | default('') == ''
      changed_when: snapshot_result.rc == 0
      failed_when: false
      tags: always

    - name: Snapshot creation result
      ansible.builtin.debug:
        msg: >-
          {{
            snapshot_result.stdout | default(
              'Using existing snapshot: ' + recent_snapshot.stdout if recent_snapshot.stdout | default('') != ''
              else 'Snapshot skipped (not btrfs or check mode)'
            )
          }}
      when: create_snapshot | default(true)
      tags: always

  roles:
    # Base setup - Flathub, prerequisites
    - role: base
      tags: [base, always]

    # Desktop applications via Flatpak
    - role: flatpak_apps
      tags: [apps, flatpak]
      when: install_flatpak_apps | default(true)

    # SSH server for remote access
    - role: ssh
      tags: [ssh, remote]
      when: install_ssh | default(true)

    # Tailscale VPN
    - role: tailscale
      tags: [tailscale, remote, vpn]
      when: install_tailscale | default(false)

    # Remote desktop (Sunshine/Moonlight)
    - role: remote_desktop
      tags: [remote_desktop, remote, streaming]
      when: install_remote_desktop | default(false)

    # Decky Loader for Gaming Mode plugins
    - role: decky
      tags: [decky, plugins, gaming]
      when: install_decky | default(true)

    # Proton tools (Proton-GE, Protontricks)
    - role: proton
      tags: [proton, gaming, wine]
      when: install_proton_tools | default(true)

    # Emulation setup (downloads EmuDeck)
    - role: emulation
      tags: [emulation, roms, gaming]
      when: install_emudeck | default(false)

    # StickDeck - Use Steam Deck as wireless controller for PC
    - role: stickdeck
      tags: [stickdeck, controller, gaming]
      when: install_stickdeck | default(false)

    # Waydroid - Android apps on Steam Deck
    - role: waydroid
      tags: [waydroid, android]
      when: install_waydroid | default(false)

    # Distrobox apps (password managers with full features)
    - role: distrobox
      tags: [distrobox, containers, password_manager]
      when: password_manager_install_method | default('flatpak') == 'distrobox'

  post_tasks:
    # Gather network information for summary
    - name: Get default network interface
      ansible.builtin.shell: |
        set -o pipefail
        ip route | grep default | awk '{print $5}' | head -1
      args:
        executable: /bin/bash
      register: default_interface
      changed_when: false
      tags: always

    - name: Get IP address
      ansible.builtin.shell: |
        set -o pipefail
        ip addr show {{ default_interface.stdout }} | grep 'inet ' | awk '{print $2}' | cut -d/ -f1
      args:
        executable: /bin/bash
      register: current_ip
      changed_when: false
      when: default_interface.stdout | length > 0
      tags: always

    - name: Get MAC address
      ansible.builtin.shell: |
        set -o pipefail
        ip link show {{ default_interface.stdout }} | grep ether | awk '{print $2}'
      args:
        executable: /bin/bash
      register: mac_address
      changed_when: false
      when: default_interface.stdout | length > 0
      tags: always

    - name: Check if using DHCP or static IP
      ansible.builtin.shell: |
        set -o pipefail
        nmcli -t -f NAME,DEVICE con show --active | grep {{ default_interface.stdout }} | cut -d: -f1
      args:
        executable: /bin/bash
      register: connection_name
      changed_when: false
      when: default_interface.stdout | length > 0
      tags: always

    - name: Get IP configuration method
      ansible.builtin.shell: |
        nmcli -t -f ipv4.method con show "{{ connection_name.stdout }}"
      register: ip_method
      changed_when: false
      when: connection_name.stdout | default('') | length > 0
      tags: always

    - name: Display system summary
      vars:
        ip_type: >-
          {{ 'Static' if 'manual' in (ip_method.stdout | default('')) else 'DHCP' }}
      ansible.builtin.debug:
        msg: |
          {% if ansible_check_mode %}
          ══════════════════════════════════════════════════════════
                              DRY RUN COMPLETE
          ══════════════════════════════════════════════════════════
          No changes were made. Run without --check to apply changes.

          {% else %}
          ══════════════════════════════════════════════════════════
                            SETUP COMPLETE
          ══════════════════════════════════════════════════════════
          {% endif %}
          System Information:
            Hostname:    {{ ansible_facts['hostname'] }}
            IP Address:  {{ current_ip.stdout | default('Unknown') }}
            IP Type:     {{ ip_type }}
            MAC Address: {{ mac_address.stdout | default('Unknown') }}
            Interface:   {{ default_interface.stdout | default('Unknown') }}

          {% if not ansible_check_mode %}
          Next steps:
            - Restart to Gaming Mode to see Decky plugins
            - Run Steam ROM Manager if you installed emulators
          {% if install_waydroid | default(false) %}  - Launch Waydroid from Gaming Mode library
          {% endif %}
            - Check the README for manual configuration steps
          {% endif %}
      tags: always
