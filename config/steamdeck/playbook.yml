# Bootible - Steam Deck Playbook
# ===============================
# Automates the setup and configuration of a Steam Deck.
#
# Usage:
#   cd steamdeck
#   ansible-playbook playbook.yml --ask-become-pass
#
# Configuration:
#   - Defaults: config.yml
#   - Your settings: ../private/steamdeck/config.yml (overrides defaults)
#   - Private files: ../private/steamdeck/files/ (Patreon downloads, etc.)
#
# See README.md for full documentation.

---
- name: Configure Steam Deck
  hosts: localhost
  gather_facts: true

  vars_files:
    - config.yml

  pre_tasks:
    - name: Verify running on Steam Deck or compatible system
      ansible.builtin.assert:
        that:
          - ansible_distribution == "Arch" or ansible_os_family == "Archlinux"
        fail_msg: "This playbook is designed for SteamOS/Arch Linux"
        success_msg: "Running on compatible system: {{ ansible_distribution }}"
      tags: always

    # Load configuration overrides
    # Priority: private repo > local ~/.config > defaults

    - name: Check for local configuration
      ansible.builtin.stat:
        path: "{{ ansible_env.HOME }}/.config/bootible/steamdeck/config.yml"
      register: local_config
      tags: always

    - name: Load local configuration
      ansible.builtin.include_vars:
        file: "{{ ansible_env.HOME }}/.config/bootible/steamdeck/config.yml"
      when: local_config.stat.exists
      tags: always

    - name: Check for private configuration
      ansible.builtin.stat:
        path: "{{ playbook_dir }}/../private/steamdeck/config.yml"
      register: private_config
      tags: always

    - name: Load private configuration
      ansible.builtin.include_vars:
        file: "{{ playbook_dir }}/../private/steamdeck/config.yml"
      when: private_config.stat.exists
      tags: always

    - name: Note configuration source
      ansible.builtin.debug:
        msg: >-
          {% if private_config.stat.exists %}Using private config (private/steamdeck/config.yml)
          {% elif local_config.stat.exists %}Using local config (~/.config/bootible/steamdeck/config.yml)
          {% else %}Using default config.yml{% endif %}
      tags: always

    # Set private files path for roles to use
    - name: Set private files path
      ansible.builtin.set_fact:
        private_files_path: "{{ playbook_dir }}/../private/steamdeck/files"
        local_files_path: "{{ playbook_dir }}/../files/steamdeck"
        has_private_files: "{{ (playbook_dir + '/../private/steamdeck/files') is directory }}"
      tags: always

    # Create btrfs snapshot before making changes
    - name: Check if home is on btrfs
      ansible.builtin.command: stat -f -c %T /home
      register: home_fs_type
      changed_when: false
      failed_when: false
      when: create_snapshot | default(true)
      tags: always

    - name: Create btrfs snapshot of home directory
      become: true
      ansible.builtin.shell: |
        set -o pipefail
        SNAPSHOT_DIR="/home/.snapshots"
        SNAPSHOT_NAME="bootible-pre-setup-$(date +%Y%m%d-%H%M%S)"
        mkdir -p "$SNAPSHOT_DIR"
        btrfs subvolume snapshot -r /home "$SNAPSHOT_DIR/$SNAPSHOT_NAME"
        echo "Created snapshot: $SNAPSHOT_DIR/$SNAPSHOT_NAME"
      args:
        executable: /bin/bash
      register: snapshot_result
      when:
        - create_snapshot | default(true)
        - home_fs_type.stdout | default('') == 'btrfs'
        - not ansible_check_mode
      changed_when: snapshot_result.rc == 0
      failed_when: false
      tags: always

    - name: Snapshot creation result
      ansible.builtin.debug:
        msg: "{{ snapshot_result.stdout | default('Snapshot skipped (not btrfs or check mode)') }}"
      when: create_snapshot | default(true)
      tags: always

  roles:
    # Base setup - Flathub, prerequisites
    - role: base
      tags: [base, always]

    # Desktop applications via Flatpak
    - role: flatpak_apps
      tags: [apps, flatpak]
      when: install_flatpak_apps | default(true)

    # SSH server for remote access
    - role: ssh
      tags: [ssh, remote]
      when: install_ssh | default(true)

    # Tailscale VPN
    - role: tailscale
      tags: [tailscale, remote, vpn]
      when: install_tailscale | default(false)

    # Remote desktop (Sunshine/Moonlight)
    - role: remote_desktop
      tags: [remote_desktop, remote, streaming]
      when: install_remote_desktop | default(false)

    # Decky Loader for Gaming Mode plugins
    - role: decky
      tags: [decky, plugins, gaming]
      when: install_decky | default(true)

    # Proton tools (Proton-GE, Protontricks)
    - role: proton
      tags: [proton, gaming, wine]
      when: install_proton_tools | default(true)

    # Emulation setup (downloads EmuDeck)
    - role: emulation
      tags: [emulation, roms, gaming]
      when: install_emudeck | default(false)

    # StickDeck - Use Steam Deck as wireless controller for PC
    - role: stickdeck
      tags: [stickdeck, controller, gaming]
      when: install_stickdeck | default(false)

    # Waydroid - Android apps on Steam Deck
    - role: waydroid
      tags: [waydroid, android]
      when: install_waydroid | default(false)

    # Distrobox apps (password managers with full features)
    - role: distrobox
      tags: [distrobox, containers, password_manager]
      when: password_manager_install_method | default('flatpak') == 'distrobox'

  post_tasks:
    # Gather network information for summary
    - name: Get default network interface
      ansible.builtin.shell: |
        set -o pipefail
        ip route | grep default | awk '{print $5}' | head -1
      args:
        executable: /bin/bash
      register: default_interface
      changed_when: false
      tags: always

    - name: Get IP address
      ansible.builtin.shell: |
        set -o pipefail
        ip addr show {{ default_interface.stdout }} | grep 'inet ' | awk '{print $2}' | cut -d/ -f1
      args:
        executable: /bin/bash
      register: current_ip
      changed_when: false
      when: default_interface.stdout | length > 0
      tags: always

    - name: Get MAC address
      ansible.builtin.shell: |
        set -o pipefail
        ip link show {{ default_interface.stdout }} | grep ether | awk '{print $2}'
      args:
        executable: /bin/bash
      register: mac_address
      changed_when: false
      when: default_interface.stdout | length > 0
      tags: always

    - name: Check if using DHCP or static IP
      ansible.builtin.shell: |
        set -o pipefail
        nmcli -t -f NAME,DEVICE con show --active | grep {{ default_interface.stdout }} | cut -d: -f1
      args:
        executable: /bin/bash
      register: connection_name
      changed_when: false
      when: default_interface.stdout | length > 0
      tags: always

    - name: Get IP configuration method
      ansible.builtin.shell: |
        nmcli -t -f ipv4.method con show "{{ connection_name.stdout }}"
      register: ip_method
      changed_when: false
      when: connection_name.stdout | default('') | length > 0
      tags: always

    - name: Display system summary
      vars:
        ip_type: >-
          {{ 'Static' if 'manual' in (ip_method.stdout | default('')) else 'DHCP' }}
      ansible.builtin.debug:
        msg: |
          {% if ansible_check_mode %}
          ══════════════════════════════════════════════════════════
                              DRY RUN COMPLETE
          ══════════════════════════════════════════════════════════
          No changes were made. Run without --check to apply changes.

          {% else %}
          ══════════════════════════════════════════════════════════
                            SETUP COMPLETE
          ══════════════════════════════════════════════════════════
          {% endif %}
          System Information:
            Hostname:    {{ ansible_hostname }}
            IP Address:  {{ current_ip.stdout | default('Unknown') }}
            IP Type:     {{ ip_type }}
            MAC Address: {{ mac_address.stdout | default('Unknown') }}
            Interface:   {{ default_interface.stdout | default('Unknown') }}

          {% if not ansible_check_mode %}
          Next steps:
            - Restart to Gaming Mode to see Decky plugins
            - Run Steam ROM Manager if you installed emulators
          {% if install_waydroid | default(false) %}  - Launch Waydroid from Gaming Mode library
          {% endif %}
            - Check the README for manual configuration steps
          {% endif %}
      tags: always
