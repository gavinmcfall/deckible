# Decky Loader Role - Gaming Mode Plugins
# ========================================
# Installs Decky Loader and configurable plugins.
#
# What is Decky Loader?
# ---------------------
# Decky lets you install plugins that add features to Gaming Mode.
# Plugins are configured in group_vars/all.yml under decky_plugins.
#
# Plugin Categories:
# ------------------
# Performance & System:
#   - PowerTools: Fine-grained CPU/GPU control, per-game profiles
#   - AutoSuspend: Auto-suspend after inactivity
#   - Battery Tracker: Track battery health over time
#
# Game Info & Store:
#   - ProtonDB Badges: Compatibility ratings in your library
#   - SteamGridDB: Custom artwork for non-Steam games
#   - HLTB: How Long to Beat game times
#   - PlayTime: Detailed play time tracking
#   - IsThereAnyDeal: Game deal notifications
#
# Customization:
#   - CSS Loader: Visual themes for Gaming Mode
#   - Animation Changer: Custom boot/suspend animations
#
# Connectivity:
#   - Bluetooth: Better Bluetooth management
#   - BT Wake Control: Bluetooth wake control
#   - Tailscale Control: VPN control from Gaming Mode
#   - KDE Connect: Phone/desktop integration
#
# Sync & Transfer:
#   - Decky Cloud Save: Cloud sync for non-Steam games
#   - DeckMTP: MTP file transfer support
#   - AutoFlatpaks: Auto-update Flatpak apps
#
# Social & Notifications:
#   - Discord Status: Show game status on Discord
#   - Decky Notifications: Desktop notifications in Gaming Mode
#
# Audio:
#   - MagicPods: AirPods battery level & controls
#
# Accessing Decky:
# ----------------
# 1. In Gaming Mode, press the ... button (Quick Access Menu)
# 2. Navigate to the Decky tab (plug icon at bottom)
#
# Troubleshooting:
# ----------------
# Decky tab not showing?
#   1. Restart Gaming Mode: hold power > Restart Steam
#   2. If still missing, reinstall by running this playbook
#
# Plugin not working?
#   1. Check for updates in Decky settings
#   2. Disable/re-enable the plugin
#   3. Check the plugin's GitHub issues

---
# Install Decky Loader
- name: Download Decky Loader installer
  ansible.builtin.get_url:
    url: https://github.com/SteamDeckHomebrew/decky-installer/releases/latest/download/install_release.sh
    dest: "{{ deck_home }}/.cache/install_decky.sh"
    mode: '0755'

- name: Run Decky Loader installer
  ansible.builtin.command:
    cmd: "{{ deck_home }}/.cache/install_decky.sh"
  become: true  # Installer needs root (calls sudo internally)
  register: decky_install
  changed_when: "'already installed' not in decky_install.stdout"

- name: Clean up Decky installer
  ansible.builtin.file:
    path: "{{ deck_home }}/.cache/install_decky.sh"
    state: absent

# Ensure plugins directory exists
- name: Ensure Decky plugins directory exists
  ansible.builtin.file:
    path: "{{ deck_home }}/homebrew/plugins"
    state: directory
    mode: '0755'

# Install Decky Plugins
# ---------------------
# Plugins are downloaded from their GitHub/GitLab releases and
# extracted to ~/homebrew/plugins/

- name: Set plugin_temp path
  ansible.builtin.set_fact:
    plugin_temp:
      path: "{{ deck_home }}/.cache/decky_plugins"

- name: Create plugin downloads directory
  ansible.builtin.file:
    path: "{{ plugin_temp.path }}"
    state: directory
    mode: '0755'

# Build list of enabled plugins
- name: Build enabled plugins list
  ansible.builtin.set_fact:
    enabled_plugins: "{{ decky_plugins | dict2items | selectattr('value.enabled', 'equalto', true) | list }}"

# Warn about rate limits if many plugins without token
- name: Warn about GitHub rate limits
  ansible.builtin.debug:
    msg: |
      ⚠️  WARNING: Installing {{ enabled_plugins | length }} plugins without a GitHub token!

      GitHub API has a rate limit of 60 requests/hour for unauthenticated users.
      With {{ enabled_plugins | length }} plugins, you may hit this limit and get partial installs.

      To avoid this, add a GitHub token to your config:
        github_token: "ghp_your_token_here"

      Create a token at: https://github.com/settings/tokens
      (No special permissions needed - just create a classic token)
  when:
    - enabled_plugins | length > 3
    - github_token is not defined or github_token == ""

# Download and install each enabled plugin
- name: Download and install Decky plugins
  ansible.builtin.include_tasks: install_plugin.yml
  loop: "{{ enabled_plugins }}"
  loop_control:
    loop_var: plugin
    label: "{{ plugin.key }}"

- name: Clean up plugin downloads
  ansible.builtin.file:
    path: "{{ plugin_temp.path }}"
    state: absent

- name: Display Decky setup info
  ansible.builtin.debug:
    msg: |
      Decky Loader and plugins installed!

      To use Decky:
      1. Switch to Gaming Mode
      2. Press the ... button (Quick Access Menu)
      3. Look for the Decky tab (plug icon at bottom)

      Installed plugins:
      {% for plugin in enabled_plugins %}
      - {{ plugin.key }}: {{ plugin.value.description }}
      {% endfor %}

      Note: Some plugins may need additional configuration.
      Open each plugin in the Decky menu to set it up.
