# Distrobox Role - Containerized Apps
# ====================================
# Uses Distrobox to run apps in containers that survive SteamOS updates.
# Containers are stored in ~/.local/share/distrobox/ (persists in home dir).
#
# Why Distrobox?
# --------------
# - Run native Linux packages (.deb, .rpm, AUR) without Flatpak limitations
# - Containers survive SteamOS updates (stored in home directory)
# - Full system integration (GUI, home dir, devices)
# - Smaller than VMs, faster than emulation
#
# Password Managers via Distrobox:
# --------------------------------
# Flatpak versions have limitations (no system auth, no SSH agent).
# Native versions in Distrobox have full features including:
# - System auth unlock (use sudo password to unlock)
# - SSH agent integration
# - Browser extension stays in sync
#
# Faster Auth on Steam Deck:
# --------------------------
# Steam Deck doesn't have a fingerprint reader, but with native installs
# you can use "system authentication" - your sudo password unlocks the app.
# This can be faster than typing your master password.

---
# Only run if distrobox install method is selected and password managers are configured
- name: Check if Distrobox installation is needed
  ansible.builtin.set_fact:
    needs_distrobox: >-
      {{ password_manager_install_method | default('flatpak') == 'distrobox'
         and (password_managers | default([])) | length > 0 }}

- name: Skip Distrobox setup
  ansible.builtin.debug:
    msg: "Distrobox not needed (using Flatpak or no password manager selected)"
  when: not needs_distrobox

# Distrobox should be pre-installed on SteamOS
- name: Check if Distrobox is available
  ansible.builtin.command: which distrobox
  register: distrobox_check
  changed_when: false
  failed_when: false
  when: needs_distrobox

- name: Warn if Distrobox not found
  ansible.builtin.fail:
    msg: "Distrobox not found. It should be pre-installed on SteamOS."
  when:
    - needs_distrobox
    - distrobox_check.rc | default(1) != 0

# Create Arch Linux container
- name: Check if Arch container exists
  ansible.builtin.command: distrobox list --no-color
  register: distrobox_list
  changed_when: false
  when:
    - needs_distrobox
    - distrobox_check.rc | default(1) == 0

- name: Check if arch container exists specifically
  ansible.builtin.set_fact:
    arch_container_exists: >-
      {{ distrobox_list.stdout_lines | default([])
         | select('match', '^arch\\s+\\|.*')
         | list | length > 0
         or distrobox_list.stdout_lines | default([])
         | select('search', '\\|\\s*arch\\s*\\|')
         | list | length > 0 }}
  when:
    - needs_distrobox
    - distrobox_check.rc | default(1) == 0

- name: Create Arch Linux container
  ansible.builtin.command: distrobox create -i archlinux:latest -n arch --yes
  register: arch_create
  when:
    - needs_distrobox
    - distrobox_check.rc | default(1) == 0
    - not (arch_container_exists | default(false))
  changed_when: arch_create.rc == 0

# Install yay (AUR helper) in the container
- name: Check if base-devel is installed
  ansible.builtin.command: distrobox enter arch -- pacman -Qi base-devel
  register: basedev_check
  changed_when: false
  failed_when: false
  when:
    - needs_distrobox
    - distrobox_check.rc | default(1) == 0

- name: Install base-devel and git in Arch container
  ansible.builtin.command: distrobox enter arch -- sudo pacman -S --needed --noconfirm base-devel git
  register: basedev_install
  when:
    - needs_distrobox
    - distrobox_check.rc | default(1) == 0
    - basedev_check.rc | default(1) != 0
  changed_when: basedev_install.rc == 0

- name: Check if yay is installed
  ansible.builtin.command: distrobox enter arch -- which yay
  register: yay_check
  changed_when: false
  failed_when: false
  when:
    - needs_distrobox
    - distrobox_check.rc | default(1) == 0

- name: Remove old yay build directory
  ansible.builtin.command: distrobox enter arch -- rm -rf /tmp/yay-bin
  when:
    - needs_distrobox
    - distrobox_check.rc | default(1) == 0
    - yay_check.rc | default(0) != 0
  changed_when: false

- name: Clone yay repository
  ansible.builtin.command: distrobox enter arch -- git clone https://aur.archlinux.org/yay-bin.git /tmp/yay-bin
  register: yay_clone
  when:
    - needs_distrobox
    - distrobox_check.rc | default(1) == 0
    - yay_check.rc | default(0) != 0
  changed_when: yay_clone.rc == 0

- name: Build and install yay
  ansible.builtin.command: distrobox enter arch -- bash -c "cd /tmp/yay-bin && makepkg -si --noconfirm"
  register: yay_install
  when:
    - needs_distrobox
    - distrobox_check.rc | default(1) == 0
    - yay_check.rc | default(0) != 0
  changed_when: yay_install.rc == 0

# ============================================================================
# 1Password
# ============================================================================
- name: Check if 1Password is installed in container
  ansible.builtin.command: distrobox enter arch -- which 1password
  register: onepassword_check
  changed_when: false
  failed_when: false
  when:
    - needs_distrobox
    - "'1password' in (password_managers | default([]))"

- name: Install 1Password from AUR
  ansible.builtin.command: distrobox enter arch -- yay -S --noconfirm 1password
  register: onepassword_install
  when:
    - needs_distrobox
    - "'1password' in (password_managers | default([]))"
    - onepassword_check.rc | default(1) != 0
  changed_when: onepassword_install.rc == 0

- name: Export 1Password to host desktop
  ansible.builtin.command: distrobox enter arch -- distrobox-export --app 1password
  when:
    - needs_distrobox
    - "'1password' in (password_managers | default([]))"
  changed_when: false
  failed_when: false

# ============================================================================
# Bitwarden
# ============================================================================
- name: Check if Bitwarden is installed in container
  ansible.builtin.command: distrobox enter arch -- which bitwarden-desktop
  register: bitwarden_check
  changed_when: false
  failed_when: false
  when:
    - needs_distrobox
    - "'bitwarden' in (password_managers | default([]))"

- name: Install Bitwarden from AUR
  ansible.builtin.command: distrobox enter arch -- yay -S --noconfirm bitwarden-desktop
  register: bitwarden_install
  when:
    - needs_distrobox
    - "'bitwarden' in (password_managers | default([]))"
    - bitwarden_check.rc | default(1) != 0
  changed_when: bitwarden_install.rc == 0

- name: Export Bitwarden to host desktop
  ansible.builtin.command: distrobox enter arch -- distrobox-export --app bitwarden-desktop
  when:
    - needs_distrobox
    - "'bitwarden' in (password_managers | default([]))"
  changed_when: false
  failed_when: false

# ============================================================================
# KeePassXC
# ============================================================================
- name: Check if KeePassXC is installed in container
  ansible.builtin.command: distrobox enter arch -- which keepassxc
  register: keepassxc_check
  changed_when: false
  failed_when: false
  when:
    - needs_distrobox
    - "'keepassxc' in (password_managers | default([]))"

- name: Install KeePassXC from Arch repos
  ansible.builtin.command: distrobox enter arch -- sudo pacman -S --noconfirm keepassxc
  register: keepassxc_install
  when:
    - needs_distrobox
    - "'keepassxc' in (password_managers | default([]))"
    - keepassxc_check.rc | default(1) != 0
  changed_when: keepassxc_install.rc == 0

- name: Export KeePassXC to host desktop
  ansible.builtin.command: distrobox enter arch -- distrobox-export --app keepassxc
  when:
    - needs_distrobox
    - "'keepassxc' in (password_managers | default([]))"
  changed_when: false
  failed_when: false

# ============================================================================
# Proton Pass
# ============================================================================
- name: Check if Proton Pass is installed in container
  ansible.builtin.command: distrobox enter arch -- which proton-pass
  register: protonpass_check
  changed_when: false
  failed_when: false
  when:
    - needs_distrobox
    - "'protonpass' in (password_managers | default([]))"

- name: Install Proton Pass from AUR
  ansible.builtin.command: distrobox enter arch -- yay -S --noconfirm proton-pass
  register: protonpass_install
  when:
    - needs_distrobox
    - "'protonpass' in (password_managers | default([]))"
    - protonpass_check.rc | default(1) != 0
  changed_when: protonpass_install.rc == 0

- name: Export Proton Pass to host desktop
  ansible.builtin.command: distrobox enter arch -- distrobox-export --app proton-pass
  when:
    - needs_distrobox
    - "'protonpass' in (password_managers | default([]))"
  changed_when: false
  failed_when: false

# ============================================================================
# Setup Info
# ============================================================================
- name: Display password manager setup info
  ansible.builtin.debug:
    msg: |
      Password managers installed via Distrobox (Arch container): {{ password_managers | join(', ') }}

      Features available (not possible with Flatpak):
      - System authentication: Use sudo password to unlock
      - SSH agent integration (1Password, KeePassXC)
      - Browser integration stays in sync

      To enable system auth (if supported):
      - 1Password: Settings > Security > Unlock with system authentication
      - Bitwarden: Settings > Security > Unlock with biometrics
      - KeePassXC: Settings > Security > Unlock with system credentials

      The apps appear in your normal application menu.
      First launch may take a moment as the container starts.
  when: needs_distrobox
