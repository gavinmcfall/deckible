# Base Role - Prerequisites and Flathub Setup
# ============================================
# This role sets up the foundation for everything else:
# - Verifies sudo access is working
# - Configures hostname and static IP (if specified)
# - Ensures Flathub repository is configured
# - Updates Flatpak apps
#
# SteamOS Note:
# The root filesystem is read-only (immutable). Traditional pacman packages
# don't persist after SteamOS updates. Flatpak is the recommended way to
# install applications - they survive updates and are sandboxed.

---
- name: Verify sudo is working
  ansible.builtin.command: sudo -n true
  register: sudo_check
  changed_when: false
  failed_when: false

- name: Fail if sudo requires password and none provided
  ansible.builtin.fail:
    msg: |
      Sudo password required. Run the playbook with --ask-become-pass:
        ansible-playbook playbook.yml --ask-become-pass

      If you haven't set a sudo password yet:
        1. Open Konsole in Desktop Mode
        2. Run: passwd
        3. Set your password
        4. Run this playbook again
  when: sudo_check.rc != 0

# Hostname Configuration
# ----------------------
# Sets the system hostname if specified in config

- name: Set hostname
  ansible.builtin.hostname:
    name: "{{ hostname }}"
  become: true
  when: hostname | default('') | length > 0
  register: hostname_changed

- name: Display hostname change
  ansible.builtin.debug:
    msg: "Hostname set to: {{ hostname }}"
  when:
    - hostname_changed is defined
    - hostname_changed is changed

# Static IP Configuration
# -----------------------
# Configures a static IP via NetworkManager if specified

- name: Configure static IP
  community.general.nmcli:
    conn_name: "{{ static_ip.connection }}"
    type: ethernet
    ip4: "{{ static_ip.address }}"
    gw4: "{{ static_ip.gateway }}"
    dns4: "{{ static_ip.dns | default([]) | select() | list }}"
    method4: manual
    state: present
    autoconnect: true
  become: true
  register: static_ip_config
  when:
    - static_ip.enabled | default(false)
    - static_ip.address | default('') | length > 0
    - static_ip.gateway | default('') | length > 0

- name: Display static IP configuration
  ansible.builtin.debug:
    msg: |
      Static IP configured:
        Connection: {{ static_ip.connection }}
        Address: {{ static_ip.address }}
        Gateway: {{ static_ip.gateway }}
        DNS: {{ static_ip.dns | default([]) | select() | join(', ') }}
  when: static_ip_config is defined and static_ip_config is changed

# Reset to DHCP if static IP is disabled
- name: Reset to DHCP
  community.general.nmcli:
    conn_name: "{{ static_ip.connection | default('Wired connection 1') }}"
    type: ethernet
    method4: auto
    dns4: []
    dns4_ignore_auto: false
    state: present
    autoconnect: true
  become: true
  register: dhcp_config
  when:
    - not (static_ip.enabled | default(false))
    - static_ip.connection | default('') | length > 0

- name: Display DHCP configuration
  ansible.builtin.debug:
    msg: "DHCP enabled on connection: {{ static_ip.connection | default('Wired connection 1') }}"
  when: dhcp_config is defined and dhcp_config is changed

# Flathub Setup
# -------------
# Flathub is the main source for Flatpak applications.
# Should be enabled by default on SteamOS, but we ensure it's there.

- name: Add Flathub repository
  community.general.flatpak_remote:
    name: flathub
    flatpakrepo_url: https://flathub.org/repo/flathub.flatpakrepo
    state: present

# Update existing Flatpaks
# ------------------------
# Keep installed apps up to date

- name: Update all Flatpak applications
  ansible.builtin.command: flatpak update -y --noninteractive
  register: flatpak_update
  changed_when: "'Nothing to do' not in flatpak_update.stdout"

# SD Card Detection
# -----------------
# Steam Deck mounts SD cards at /run/media/mmcblk0p1
# We detect if one is present and set facts for other roles to use.

- name: Check for SD card
  ansible.builtin.stat:
    path: /run/media/mmcblk0p1
  register: sdcard_check

- name: Check SD card is writable
  ansible.builtin.file:
    path: /run/media/mmcblk0p1/.deckible_test
    state: touch
    mode: '0644'
  register: sdcard_write_test
  when: sdcard_check.stat.exists
  failed_when: false
  changed_when: false

- name: Clean up SD card test file
  ansible.builtin.file:
    path: /run/media/mmcblk0p1/.deckible_test
    state: absent
  when:
    - sdcard_check.stat.exists
    - sdcard_write_test is succeeded
  changed_when: false

- name: Set SD card facts
  ansible.builtin.set_fact:
    sdcard_present: "{{ sdcard_check.stat.exists }}"
    sdcard_writable: "{{ (sdcard_write_test is succeeded) if sdcard_check.stat.exists else false }}"
    sdcard_path: "{{ '/run/media/mmcblk0p1' if sdcard_check.stat.exists else '' }}"

- name: Display SD card status
  ansible.builtin.debug:
    msg: |
      SD Card: {{ 'Detected at ' + sdcard_path if sdcard_present else 'Not detected' }}
      {{ 'Writable: Yes' if sdcard_writable else 'Writable: No' if sdcard_present else '' }}
  when: sdcard_present

# Shader Cache on SD Card
# -----------------------
# Steam's shader cache can grow to 10-50GB+, eating internal storage.
# Moving it to SD card frees up space for games.
# This creates a symlink from the internal location to SD card.

- name: Check if shader cache move is requested
  ansible.builtin.set_fact:
    should_move_shader_cache: "{{ move_shader_cache | default(false) and sdcard_present and sdcard_writable }}"

- name: Get current shader cache location
  ansible.builtin.stat:
    path: "{{ deck_home }}/.steam/steam/steamapps/shadercache"
  register: shadercache_stat
  when: should_move_shader_cache

- name: Check if shader cache is already a symlink
  ansible.builtin.set_fact:
    shadercache_is_symlink: "{{ shadercache_stat.stat.islnk | default(false) }}"
  when: should_move_shader_cache

- name: Create shader cache directory on SD card
  ansible.builtin.file:
    path: "{{ sdcard_path }}/steamapps/shadercache"
    state: directory
    mode: '0755'
  when:
    - should_move_shader_cache
    - not shadercache_is_symlink

- name: Move existing shader cache to SD card
  ansible.builtin.shell: |
    if [ -d "{{ deck_home }}/.steam/steam/steamapps/shadercache" ] && [ ! -L "{{ deck_home }}/.steam/steam/steamapps/shadercache" ]; then
      rsync -a --remove-source-files "{{ deck_home }}/.steam/steam/steamapps/shadercache/" "{{ sdcard_path }}/steamapps/shadercache/" && \
        rm -rf "{{ deck_home }}/.steam/steam/steamapps/shadercache"
    fi
  register: shader_move_result
  failed_when: shader_move_result.rc != 0
  when:
    - should_move_shader_cache
    - not shadercache_is_symlink
    - shadercache_stat.stat.exists | default(false)
  changed_when: true

- name: Create symlink for shader cache
  ansible.builtin.file:
    src: "{{ sdcard_path }}/steamapps/shadercache"
    dest: "{{ deck_home }}/.steam/steam/steamapps/shadercache"
    state: link
    force: true
  when:
    - should_move_shader_cache
    - not shadercache_is_symlink

- name: Display shader cache status
  ansible.builtin.debug:
    msg: |
      Shader cache moved to SD card: {{ sdcard_path }}/steamapps/shadercache
      Internal storage freed!
  when:
    - should_move_shader_cache
    - not shadercache_is_symlink
