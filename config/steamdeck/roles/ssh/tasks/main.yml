# SSH Role - Remote Access & Key Management
# ==========================================
# Enables SSH server and manages SSH keys for Steam Deck.
#
# Features:
# - Enable SSH server for remote access
# - Import authorized keys from private repo
# - Generate device SSH key
# - Add key to GitHub via gh CLI
# - Save key to private repo for backup
# - Configure git to use SSH for GitHub
#
# After this role runs, connect from another computer:
#   ssh deck@<your-deck-ip>
#
# Finding your IP address:
#   Gaming Mode: Settings > Internet > (your connection) > IP Address
#   Desktop Mode: System Settings > Network > (your connection)
#   Terminal: ip addr show | grep "inet "

---
# =============================================================================
# SSH SERVER
# =============================================================================

- name: Enable SSH service
  become: true
  ansible.builtin.systemd:
    name: sshd
    enabled: true
    state: started

- name: Ensure SSH service starts on boot
  become: true
  ansible.builtin.systemd:
    name: sshd
    enabled: true

# Configure custom SSH port if specified
- name: Configure SSH port
  become: true
  ansible.builtin.lineinfile:
    path: /etc/ssh/sshd_config
    regexp: '^#?Port '
    line: "Port {{ ssh_port }}"
    state: present
  when: ssh_port | default(22) != 22
  register: ssh_port_config

- name: Restart SSH if port changed  # noqa: no-handler
  become: true
  ansible.builtin.systemd:
    name: sshd
    state: restarted
  when: ssh_port_config.changed | default(false)

# =============================================================================
# IMPORT AUTHORIZED KEYS
# =============================================================================

- name: Ensure .ssh directory exists
  ansible.builtin.file:
    path: "{{ deck_home }}/.ssh"
    state: directory
    mode: '0700'
  when: ssh_import_authorized_keys | default(false)

- name: Find authorized keys in private repo
  ansible.builtin.find:
    paths:
      - "{{ playbook_dir }}/../private/steamdeck/ssh-keys"
      - "{{ playbook_dir }}/../private/steamdeck/files/ssh-keys"
      - "{{ playbook_dir }}/../private/ssh-keys"
      - "{{ playbook_dir }}/../private/files/ssh-keys"
    patterns: "*.pub"
  register: all_pubkeys
  when: ssh_import_authorized_keys | default(false)

- name: Build list of keys to import
  ansible.builtin.set_fact:
    keys_to_import: >-
      {{ all_pubkeys.files | default([])
        | selectattr('path', 'defined')
        | map(attribute='path')
        | select('search', '(' + (ssh_authorized_keys | default([]) | join('|')) + ')')
        | list }}
  when:
    - ssh_import_authorized_keys | default(false)
    - ssh_authorized_keys | default([]) | length > 0

- name: Import all keys if no specific list provided
  ansible.builtin.set_fact:
    keys_to_import: "{{ all_pubkeys.files | default([]) | map(attribute='path') | list }}"
  when:
    - ssh_import_authorized_keys | default(false)
    - ssh_authorized_keys | default([]) | length == 0

- name: Read public keys content
  ansible.builtin.slurp:
    src: "{{ item }}"
  register: pubkey_contents
  loop: "{{ keys_to_import | default([]) }}"
  when: ssh_import_authorized_keys | default(false)

- name: Write authorized_keys file
  ansible.builtin.copy:
    content: |
      # Managed by bootible - imported from private repo
      {% for key in pubkey_contents.results | default([]) %}
      # {{ key.item | basename }}
      {{ key.content | b64decode }}
      {% endfor %}
    dest: "{{ deck_home }}/.ssh/authorized_keys"
    mode: '0600'
  when:
    - ssh_import_authorized_keys | default(false)
    - pubkey_contents.results | default([]) | length > 0

- name: Display imported keys
  ansible.builtin.debug:
    msg: "Imported {{ keys_to_import | default([]) | length }} SSH key(s): {{ keys_to_import | default([]) | map('basename') | join(', ') }}"
  when:
    - ssh_import_authorized_keys | default(false)
    - keys_to_import | default([]) | length > 0

# =============================================================================
# KEY GENERATION
# =============================================================================

- name: Set SSH key name
  ansible.builtin.set_fact:
    ssh_key_identifier: "{{ ssh_key_name | default(ansible_facts['hostname'], true) }}"
  when: ssh_generate_key | default(false)

- name: Check if SSH key exists
  ansible.builtin.stat:
    path: "{{ deck_home }}/.ssh/id_ed25519"
  register: existing_key
  when: ssh_generate_key | default(false)

- name: Generate SSH key
  ansible.builtin.command:
    cmd: ssh-keygen -t ed25519 -C "{{ ssh_key_identifier }}" -f "{{ deck_home }}/.ssh/id_ed25519" -N ""
    creates: "{{ deck_home }}/.ssh/id_ed25519"
  when:
    - ssh_generate_key | default(false)
    - not existing_key.stat.exists | default(false)

- name: Check if public key exists (for check mode)
  ansible.builtin.stat:
    path: "{{ deck_home }}/.ssh/id_ed25519.pub"
  register: pubkey_exists
  when: ssh_generate_key | default(false)

- name: Read generated public key
  ansible.builtin.slurp:
    src: "{{ deck_home }}/.ssh/id_ed25519.pub"
  register: generated_pubkey
  when:
    - ssh_generate_key | default(false)
    - pubkey_exists.stat.exists | default(false)

# =============================================================================
# GITHUB INTEGRATION
# =============================================================================

- name: Check if gh CLI is available
  ansible.builtin.command:
    cmd: which gh
  register: gh_available
  failed_when: false
  changed_when: false
  when: ssh_add_to_github | default(false) or ssh_configure_git | default(false)

- name: Check gh auth status
  ansible.builtin.command:
    cmd: gh auth status
  register: gh_auth_status
  failed_when: false
  changed_when: false
  when:
    - gh_available.rc | default(1) == 0
    - ssh_add_to_github | default(false)

- name: Add SSH key to GitHub
  ansible.builtin.command:
    cmd: gh ssh-key add "{{ deck_home }}/.ssh/id_ed25519.pub" --title "{{ ssh_key_identifier }}"
  when:
    - ssh_add_to_github | default(false)
    - ssh_generate_key | default(false)
    - gh_available.rc | default(1) == 0
    - gh_auth_status.rc | default(1) == 0
  register: gh_key_add
  failed_when: false

- name: Display GitHub key add result
  ansible.builtin.debug:
    msg: "{{ 'SSH key added to GitHub' if gh_key_add.rc | default(1) == 0 else 'Could not add key to GitHub (may already exist): ' + (gh_key_add.stderr | default('')) }}"
  when: ssh_add_to_github | default(false)

# WARNING: This rewrites all HTTPS GitHub URLs to SSH globally.
# This can break the bootstrap script if run again (expects HTTPS).
# Only enable if you understand the implications and have SSH keys
# properly configured on GitHub.
- name: Configure git to use SSH for GitHub
  ansible.builtin.command:
    cmd: git config --global url."git@github.com:".insteadOf "https://github.com/"
  when:
    - ssh_configure_git | default(false)
    - gh_available.rc | default(1) == 0
  changed_when: true

# =============================================================================
# SAVE KEY TO PRIVATE REPO
# =============================================================================

- name: Ensure private repo ssh-keys directory exists
  ansible.builtin.file:
    path: "{{ playbook_dir }}/../private/steamdeck/ssh-keys"
    state: directory
    mode: '0755'
  when:
    - ssh_save_to_private | default(false)
    - ssh_generate_key | default(false)
  register: ssh_keys_dir

- name: Check if ssh-keys directory exists (for check mode)
  ansible.builtin.stat:
    path: "{{ playbook_dir }}/../private/steamdeck/ssh-keys"
  register: ssh_keys_dir_stat
  when:
    - ssh_save_to_private | default(false)
    - ssh_generate_key | default(false)

- name: Copy public key to private repo
  ansible.builtin.copy:
    src: "{{ deck_home }}/.ssh/id_ed25519.pub"
    dest: "{{ playbook_dir }}/../private/steamdeck/ssh-keys/{{ ssh_key_identifier }}.pub"
    mode: '0644'
    remote_src: true
  when:
    - ssh_save_to_private | default(false)
    - ssh_generate_key | default(false)
    - pubkey_exists.stat.exists | default(false)
    - ssh_keys_dir_stat.stat.exists | default(false)

- name: Display key saved message
  ansible.builtin.debug:
    msg: "SSH public key saved to private/steamdeck/ssh-keys/{{ ssh_key_identifier }}.pub"
  when:
    - ssh_save_to_private | default(false)
    - ssh_generate_key | default(false)

# =============================================================================
# SUMMARY
# =============================================================================

- name: Display SSH connection info
  ansible.builtin.debug:
    msg: |
      SSH is now enabled!

      Connect with: ssh deck@<your-deck-ip>{{ ' -p ' + (ssh_port | string) if ssh_port | default(22) != 22 else '' }}
      {% if ssh_import_authorized_keys | default(false) and keys_to_import | default([]) | length > 0 %}
      Authentication: SSH keys imported ({{ keys_to_import | length }} key(s))
      {% else %}
      Password: Your sudo password
      {% endif %}
      {% if ssh_port | default(22) != 22 %}
      Custom port: {{ ssh_port }}
      {% endif %}
      {% if ssh_generate_key | default(false) %}

      Generated key: {{ deck_home }}/.ssh/id_ed25519.pub
      {% if ssh_add_to_github | default(false) %}  → Added to GitHub{% endif %}
      {% if ssh_save_to_private | default(false) %}  → Saved to private repo{% endif %}
      {% endif %}

      To find your IP:
        Gaming Mode: Settings > Internet > IP Address
        Desktop: ip addr show
